#!/usr/bin/env php
<?php

/*
 * This file is part of DOM-ORM.
 *
 * (c) Erik PÃ¶hler <info@erikpoehler.com>
 *
 * This source file is subject to the MIT license that is bundled
 * with this source code in the file LICENSE.
 */

error_reporting(E_ALL & ~E_DEPRECATED & ~E_USER_DEPRECATED);

set_error_handler(static function ($severity, $message, $file, $line) {
    if ($severity & error_reporting()) {
        throw new ErrorException($message, 0, $severity, $file, $line);
    }
});

$possibleFiles = [__DIR__.'/../../autoload.php', __DIR__.'/../autoload.php', __DIR__.'/vendor/autoload.php'];
$file = null;
foreach ($possibleFiles as $possibleFile) {
    if (file_exists($possibleFile)) {
        $file = $possibleFile;

        break;
    }
}

if (null === $file) {
    throw new RuntimeException('Unable to locate autoload.php file.');
}

require_once $file;

use DOM\ORM\Command\Backup;
use DOM\ORM\Command\Init;
use Silly\Application;
use Symfony\Component\Console\Output\ConsoleOutputInterface;

$app = new Application('DOM-ORM CLI Tool', '0.1.0');

$app->command('list', function (ConsoleOutputInterface $output) {
    $output->writeln('Available commands:');
    $output->writeln('list');
    $output->writeln('init');
    $output->writeln('backup');
    $output->writeln('schema-validate');
    $output->writeln('import [file]');
    $output->writeln('export [file] --<format>');
    $output->writeln('diagnose');
});

$app->command('init', function (ConsoleOutputInterface $output) {
    $output->writeln('Initializing database...');
    Init::run();
    $output->writeln('Done.');
});

$app->command('backup', function (ConsoleOutputInterface $output) {
    $output->writeln('Creating a database backup...');
    Backup::run();
    $output->writeln('Done.');
});

$app->command('schema-validate', function (ConsoleOutputInterface $output) {
    $output->writeln('Validating database against schema...');
    Validate::run();
    $output->writeln('Done.');
});

$app->command('import [file]', function ( $file, ConsoleOutputInterface $output) {
    $output->writeln('Importing into database...');
    Import::run();
    $output->writeln('Done.');
});

$app->command('export [file] [--xml] [--yaml] [--json] [--php]', function ($file, $xml, $yaml, $json, $php, ConsoleOutputInterface $output) {
    $output->writeln('Exporting database...');
    Export::run($file, $xml, $yaml, $json, $php);
    $output->writeln('Done.');
});

$app->command('diagnose', function (ConsoleOutputInterface $output) {
    Diagnose::run();
});

$app->setDefaultCommand('list');
$app->run();

__HALT_COMPILER();